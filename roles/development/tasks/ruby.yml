---
- name: "Create directories for ruby tools"
  file:
    path: "/tmp/{{ item }}"
    state: directory
  with_items: [ruby-install, chruby]

- name: Unarchive ruby-install
  unarchive:
    remote_src: True
    src: https://github.com/postmodern/ruby-install/archive/v0.7.0.tar.gz
    dest: /tmp/ruby-install
  register: ruby-install_unarchive

- name: Install ruby-install
  shell: make install chdir=/tmp/ruby-install
  when: ruby-install_unarchive.changed

- name: Unarchive chruby
  unarchive:
    remote_src: True
    src: https://github.com/postmodern/chruby/archive/v0.3.9.tar.gz
    dest: /tmp/chruby
  register: chruby_unarchive

- name: Install chruby
  shell: make install chdir=/tmp/chruby
  when: chruby_unarchive.changed

- name: Install latest ruby
  become_user: "{{ primary_user }}"
  shell: ruby-install ruby 2.5

- name: Install bundler
  become_user: "{{ primary_user }}"
  shell: chruby 2.5 && gem install bundler
